name: Preview Agent Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths:
      - 'apps/agent/**'

env:
  LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}

jobs:
  preview:
    name: Deploy Preview to LangSmith
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    defaults:
      run:
        working-directory: apps/agent

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Install LangGraph CLI
        run: uv pip install langgraph-cli

      - name: Deploy Preview to LangSmith
        id: deploy
        run: |
          set -e
          
          # Deploy with a unique revision name for this PR
          REVISION_NAME="pr-${{ github.event.pull_request.number }}"
          echo "ðŸš€ Deploying revision: $REVISION_NAME"
          
          # Run deployment and capture output
          if uv run langgraph deploy \
            --config langgraph.json \
            --revision "$REVISION_NAME" \
            --wait \
            2>&1 | tee deploy_output.txt; then
            echo "âœ… Deployment successful"
            DEPLOY_STATUS="success"
          else
            echo "âŒ Deployment failed"
            DEPLOY_STATUS="failure"
            cat deploy_output.txt
            exit 1
          fi
          
          # Try to extract the deployment URL from output
          DEPLOY_URL=$(grep -oP 'https://[^\s]+\.langgraph\.app' deploy_output.txt | head -1 || echo "")
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "deploy_status=$DEPLOY_STATUS" >> $GITHUB_OUTPUT
        env:
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}

      - name: Add Workflow Summary
        if: always()
        run: |
          echo "## ðŸ¤– Agent Preview Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Revision:** \`pr-${{ github.event.pull_request.number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.deploy.outputs.deploy_status }}" == "success" ]; then
            echo "**Status:** âœ… Deployed successfully" >> $GITHUB_STEP_SUMMARY
            echo "**URL:** ${{ steps.deploy.outputs.deploy_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ Deployment failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const deployUrl = '${{ steps.deploy.outputs.deploy_url }}' || 'Check LangSmith dashboard';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– Agent Preview Deployed
              
              | Resource | URL |
              |----------|-----|
              | **Agent Preview** | ${deployUrl} |
              | **LangSmith Dashboard** | [View Deployments](https://smith.langchain.com/o/${{ secrets.LANGSMITH_WORKSPACE_ID }}/deployments) |
              
              **Revision:** \`pr-${{ github.event.pull_request.number }}\`
              
              Test this preview by updating your frontend URL params:
              \`\`\`
              ?apiUrl=${deployUrl}&assistantId=deep_research
              \`\`\`
              `
            })

  cleanup:
    name: Cleanup Preview on PR Close
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    steps:
      - name: Log Cleanup Information
        run: |
          echo "## ðŸ§¹ Preview Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Merged:** ${{ github.event.pull_request.merged }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Preview Revision" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Revision \`pr-${{ github.event.pull_request.number }}\` is no longer needed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** LangSmith revisions are lightweight when inactive." >> $GITHUB_STEP_SUMMARY
          echo "If cleanup is desired, delete manually from the [LangSmith Dashboard](https://smith.langchain.com/o/${{ secrets.LANGSMITH_WORKSPACE_ID }}/deployments)." >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR about cleanup
        if: github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ§¹ Preview Cleanup
              
              PR merged! The preview revision \`pr-${{ github.event.pull_request.number }}\` is no longer active.
              
              Production deployment will be triggered automatically by the merge to main.
              
              > **Note:** Preview revisions are lightweight when inactive. No manual cleanup required.
              `
            })

