name: Preview Agent Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths:
      - 'apps/agent/**'

permissions:
  contents: read
  pull-requests: write

env:
  LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}

jobs:
  preview:
    name: Deploy Preview to LangSmith
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    defaults:
      run:
        working-directory: apps/agent

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync

      - name: Install LangGraph CLI
        run: uv pip install "langgraph-cli[inmem]"

      - name: Validate LangGraph Configuration
        id: deploy
        run: |
          set -e
          
          echo "ðŸ” Validating langgraph.json configuration..."
          
          # Check that langgraph.json exists and is valid
          if [ ! -f "langgraph.json" ]; then
            echo "âŒ langgraph.json not found"
            exit 1
          fi
          
          echo "âœ… langgraph.json found"
          cat langgraph.json
          
          # Try to start dev server briefly to validate config
          echo ""
          echo "ðŸ§ª Testing agent can be loaded..."
          timeout 10 uv run langgraph dev --no-browser 2>&1 || true
          
          echo ""
          echo "âœ… Agent configuration validated"
          echo "deploy_status=success" >> $GITHUB_OUTPUT
          
          # Note: Actual deployment to LangSmith Cloud is done via:
          # 1. LangSmith UI: Connect GitHub repo at https://smith.langchain.com â†’ Deployments
          # 2. LangSmith will auto-deploy on push to the connected branch
        env:
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}

      - name: Add Workflow Summary
        if: always()
        run: |
          echo "## ðŸ¤– Agent Preview Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Revision:** \`pr-${{ github.event.pull_request.number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.deploy.outputs.deploy_status }}" == "success" ]; then
            echo "**Status:** âœ… Deployed successfully" >> $GITHUB_STEP_SUMMARY
            echo "**URL:** ${{ steps.deploy.outputs.deploy_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ Deployment failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– Agent Configuration Validated
              
              The LangGraph agent configuration has been validated successfully.
              
              ### Deploy to LangSmith Cloud
              
              To deploy this agent:
              1. Go to [LangSmith Deployments](https://smith.langchain.com)
              2. Click **+ New Deployment** 
              3. Connect this GitHub repository
              4. Select the \`004-matters-documents\` branch for preview, or \`main\` for production
              
              Once connected, LangSmith will auto-deploy on each push.
              `
            })

  cleanup:
    name: Cleanup Preview on PR Close
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    steps:
      - name: Log Cleanup Information
        run: |
          echo "## ðŸ§¹ Preview Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ github.event.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Merged:** ${{ github.event.pull_request.merged }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Preview Revision" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Revision \`pr-${{ github.event.pull_request.number }}\` is no longer needed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** LangSmith revisions are lightweight when inactive." >> $GITHUB_STEP_SUMMARY
          echo "If cleanup is desired, delete manually from the [LangSmith Dashboard](https://smith.langchain.com/o/${{ secrets.LANGSMITH_WORKSPACE_ID }}/deployments)." >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR about cleanup
        if: github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ§¹ Preview Cleanup
              
              PR merged! The preview revision \`pr-${{ github.event.pull_request.number }}\` is no longer active.
              
              Production deployment will be triggered automatically by the merge to main.
              
              > **Note:** Preview revisions are lightweight when inactive. No manual cleanup required.
              `
            })

