name: Supabase Branch Preview

on:
  pull_request:
    branches: [main]
    paths:
      - 'supabase/**'
    types: [opened, synchronize, reopened, closed]

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}

jobs:
  create-branch:
    name: Create Preview Branch
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    outputs:
      branch_url: ${{ steps.create.outputs.branch_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Create Supabase Branch
        id: create
        run: |
          # Branch name from PR (sanitized)
          BRANCH_NAME="pr-${{ github.event.pull_request.number }}"
          
          echo "Creating Supabase branch: $BRANCH_NAME"
          
          # Link to project
          supabase link --project-ref $SUPABASE_PROJECT_ID
          
          # Create branch (will fail gracefully if exists)
          supabase branches create $BRANCH_NAME || echo "Branch may already exist"
          
          # Get branch details
          BRANCH_INFO=$(supabase branches list --output json | jq -r ".[] | select(.name == \"$BRANCH_NAME\")")
          
          if [ -n "$BRANCH_INFO" ]; then
            BRANCH_ID=$(echo $BRANCH_INFO | jq -r '.id')
            echo "branch_id=$BRANCH_ID" >> $GITHUB_OUTPUT
            echo "branch_url=https://supabase.com/dashboard/project/$SUPABASE_PROJECT_ID/branches/$BRANCH_ID" >> $GITHUB_OUTPUT
            echo "‚úÖ Supabase preview branch created: $BRANCH_NAME"
          fi

      - name: Apply Migrations
        run: |
          BRANCH_NAME="pr-${{ github.event.pull_request.number }}"
          
          # Push migrations to the branch
          # Use --include-all to include seed data, continue on error for migration drift
          supabase db push --include-all || {
            echo "‚ö†Ô∏è Migration push had issues - this may be due to migration drift"
            echo "Attempting to sync with remote..."
            supabase db pull --schema public || true
            echo "Please check migrations manually if issues persist"
          }
          
          echo "‚úÖ Migrations step completed"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const branchUrl = '${{ steps.create.outputs.branch_url }}';
            const branchName = 'pr-${{ github.event.pull_request.number }}';
            
            const body = `## üóÑÔ∏è Supabase Preview Branch
            
            | Resource | Link |
            |----------|------|
            | Branch | \`${branchName}\` |
            | Dashboard | [View Branch](${branchUrl}) |
            
            ### Migrations Applied
            All migrations from \`supabase/migrations/\` have been applied to this preview branch.
            
            ### Connection Info
            Use the branch database URL from the Supabase dashboard for testing.
            
            ---
            *This branch will be deleted when the PR is closed.*`;
            
            // Check if comment already exists
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const existingComment = comments.find(c => 
              c.body.includes('Supabase Preview Branch') && 
              c.user.type === 'Bot'
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

  cleanup-branch:
    name: Delete Preview Branch
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Delete Supabase Branch
        run: |
          BRANCH_NAME="pr-${{ github.event.pull_request.number }}"
          
          supabase link --project-ref $SUPABASE_PROJECT_ID
          
          # Delete the branch
          supabase branches delete $BRANCH_NAME --confirm || echo "Branch may not exist"
          
          echo "üóëÔ∏è Supabase preview branch deleted: $BRANCH_NAME"

