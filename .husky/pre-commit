#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Run pre-commit quality gates
# This ensures all tests, linting, and builds pass before committing

echo "üîç Running pre-commit quality gates..."

# Change to repo root
cd "$(git rev-parse --show-toplevel)"

# Track if any checks fail
FAILED=0

# 1. Frontend Checks
if git diff --cached --name-only | grep -q "^apps/frontend/"; then
  echo ""
  echo "üì¶ Running frontend checks..."
  
  # Lint
  echo "  ‚Üí Running ESLint..."
  pnpm --filter frontend lint || {
    echo "‚ùå Frontend linting failed. Run 'pnpm --filter frontend lint:fix' to fix."
    FAILED=1
  }
  
  # Format check
  echo "  ‚Üí Checking Prettier formatting..."
  pnpm --filter frontend format:check || {
    echo "‚ùå Frontend formatting failed. Run 'pnpm --filter frontend format' to fix."
    FAILED=1
  }
  
  # Type check
  echo "  ‚Üí Running TypeScript type check..."
  pnpm --filter frontend tsc --noEmit || {
    echo "‚ùå Frontend type check failed."
    FAILED=1
  }
  
  # Build check (catches production build errors)
  echo "  ‚Üí Running production build check..."
  pnpm --filter frontend build || {
    echo "‚ùå Frontend build failed. Fix build errors before committing."
    FAILED=1
  }
  
  # Tests (if they exist)
  if [ -d "apps/frontend/src/__tests__" ] || [ -d "apps/frontend/__tests__" ] || [ -f "apps/frontend/package.json" ] && grep -q '"test"' apps/frontend/package.json; then
    echo "  ‚Üí Running frontend tests..."
    pnpm --filter frontend test 2>/dev/null || {
      echo "‚ùå Frontend tests failed."
      FAILED=1
    }
  else
    echo "  ‚ö†Ô∏è  No frontend tests found (tests directory or test script missing)"
  fi
fi

# 2. Agent Checks
if git diff --cached --name-only | grep -q "^apps/agent/"; then
  echo ""
  echo "üêç Running agent checks..."
  
  cd apps/agent || exit 1
  
  # Lint (if ruff is available - CI will enforce if not)
  if command -v ruff >/dev/null 2>&1; then
    echo "  ‚Üí Running Ruff linter..."
    ruff check . || {
      echo "‚ùå Agent linting failed. Run 'ruff check . --fix' to auto-fix some issues."
      FAILED=1
    }
    
    # Format check
    echo "  ‚Üí Checking Ruff formatting..."
    ruff format --check . || {
      echo "‚ùå Agent formatting failed. Run 'ruff format .' to fix."
      FAILED=1
    }
  else
    echo "  ‚ö†Ô∏è  Ruff not installed locally, skipping (CI will enforce)"
  fi
  
  # Type check (if mypy is available)
  if command -v mypy >/dev/null 2>&1 || python -m mypy --version >/dev/null 2>&1; then
    echo "  ‚Üí Running mypy type check..."
    mypy src --ignore-missing-imports 2>/dev/null || {
      echo "‚ö†Ô∏è  Agent type check had issues (continuing...)"
    }
  fi
  
  # Tests (if they exist)
  if [ -d "tests" ]; then
    echo "  ‚Üí Running agent tests..."
    pytest tests/ -v || {
      echo "‚ùå Agent tests failed."
      FAILED=1
    }
  else
    echo "  ‚ö†Ô∏è  No agent tests found (tests directory missing)"
  fi
  
  cd ../..
fi

# 3. Database Checks (SQL migrations)
if git diff --cached --name-only | grep -q "^supabase/migrations/"; then
  echo ""
  echo "üóÑÔ∏è  Running database checks..."
  
  # Basic SQL syntax validation (check for RLS policies on new tables)
  for file in $(git diff --cached --name-only | grep "^supabase/migrations/.*\.sql$"); do
    if grep -qi "create table" "$file"; then
      if ! grep -qi "enable row level security" "$file"; then
        echo "‚ùå Migration $file creates table(s) but doesn't enable RLS"
        echo "   All tables MUST have Row Level Security enabled."
        FAILED=1
      fi
    fi
  done
fi

# Exit with error if any check failed
if [ $FAILED -eq 1 ]; then
  echo ""
  echo "‚ùå Pre-commit checks failed. Please fix the errors above before committing."
  echo "   Use 'git commit --no-verify' to skip checks (not recommended)."
  exit 1
fi

echo ""
echo "‚úÖ All pre-commit checks passed!"
exit 0
