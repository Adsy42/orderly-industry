#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Check if frontend files are staged
FRONTEND_STAGED=$(git diff --cached --name-only | grep "^apps/frontend/" || true)
if [ -n "$FRONTEND_STAGED" ]; then
  echo "ğŸ“¦ Frontend changes detected - running checks..."
  
  cd apps/frontend
  
  # Lint
  echo "  â†’ ESLint..."
  pnpm lint || {
    echo "âŒ ESLint failed. Fix errors before committing."
    exit 1
  }
  
  # Type check
  echo "  â†’ TypeScript..."
  pnpm tsc --noEmit || {
    echo "âŒ TypeScript check failed. Fix errors before committing."
    exit 1
  }
  
  cd ../..
  echo "âœ… Frontend checks passed"
fi

# Check if agent files are staged
AGENT_STAGED=$(git diff --cached --name-only | grep "^apps/agent/" || true)
if [ -n "$AGENT_STAGED" ]; then
  echo "ğŸ Agent changes detected - running checks..."
  
  cd apps/agent
  
  # Lint with ruff
  echo "  â†’ Ruff lint..."
  ruff check . || {
    echo "âŒ Ruff lint failed. Fix errors before committing."
    exit 1
  }
  
  # Format check with ruff
  echo "  â†’ Ruff format..."
  ruff format --check . || {
    echo "âŒ Ruff format check failed. Run 'ruff format .' to fix."
    exit 1
  }
  
  cd ../..
  echo "âœ… Agent checks passed"
fi

# Check if database files are staged
DB_STAGED=$(git diff --cached --name-only | grep "^supabase/migrations/" || true)
if [ -n "$DB_STAGED" ]; then
  echo "ğŸ—„ï¸ Database changes detected - validating migrations..."
  
  # Check migration naming
  for file in $(git diff --cached --name-only | grep "^supabase/migrations/.*\.sql$"); do
    filename=$(basename "$file")
    if ! echo "$filename" | grep -qE '^[0-9]{14}_[a-z_]+\.sql$'; then
      echo "âŒ Invalid migration name: $filename"
      echo "   Expected format: YYYYMMDDHHmmss_description.sql"
      exit 1
    fi
  done
  
  # Check for RLS in new tables
  for file in $(git diff --cached --name-only | grep "^supabase/migrations/.*\.sql$"); do
    if git diff --cached "$file" | grep -qi "create table"; then
      if ! git diff --cached "$file" | grep -qi "enable row level security"; then
        echo "âŒ $file creates table but doesn't enable RLS"
        echo "   Constitution requires: All tables MUST have RLS enabled"
        exit 1
      fi
    fi
  done
  
  echo "âœ… Database checks passed"
fi

echo "ğŸ‰ All pre-commit checks passed!"

