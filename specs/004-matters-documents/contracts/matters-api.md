# API Contract: Matters

**Feature Branch**: `004-matters-documents`  
**Date**: 2025-12-23  
**Base Path**: Supabase Auto-generated REST API (`/rest/v1/matters`)

## Overview

Matters are accessed via Supabase's auto-generated REST API. The frontend uses the Supabase client library which wraps these endpoints. Custom API routes are only needed for complex operations.

## Endpoints

### List Matters

**Request**:

```
GET /rest/v1/matters
Authorization: Bearer {jwt}
apikey: {anon_key}
```

**Query Parameters**:
| Parameter | Type | Description |
|-----------|------|-------------|
| `select` | string | Columns to return (default: `*`) |
| `order` | string | Sort order (default: `updated_at.desc`) |
| `limit` | integer | Max results (default: 50) |
| `offset` | integer | Pagination offset |
| `status` | string | Filter by status (eq.active) |

**Response** (200 OK):

```json
[
  {
    "id": "uuid",
    "title": "Smith v Jones",
    "description": "Commercial dispute regarding...",
    "matter_number": "M-2025-001",
    "status": "active",
    "jurisdiction": "AU",
    "created_by": "uuid",
    "created_at": "2025-12-23T10:00:00Z",
    "updated_at": "2025-12-23T15:30:00Z"
  }
]
```

**TypeScript Usage**:

```typescript
const { data, error } = await supabase
  .from("matters")
  .select("*")
  .order("updated_at", { ascending: false })
  .limit(50);
```

---

### Get Matter with Documents Count

**Request**:

```
GET /rest/v1/matters?select=*,documents(count)&id=eq.{id}
```

**Response** (200 OK):

```json
[
  {
    "id": "uuid",
    "title": "Smith v Jones",
    "matter_number": "M-2025-001",
    "status": "active",
    "documents": [{ "count": 15 }]
  }
]
```

**TypeScript Usage**:

```typescript
const { data, error } = await supabase
  .from("matters")
  .select("*, documents(count)")
  .eq("id", matterId)
  .single();
```

---

### Create Matter

**Request**:

```
POST /rest/v1/matters
Authorization: Bearer {jwt}
Content-Type: application/json
Prefer: return=representation

{
  "title": "Smith v Jones",
  "description": "Commercial dispute..."
}
```

**Notes**:

- `matter_number` auto-generated by trigger
- `created_by` auto-set from JWT
- `status` defaults to "active"
- `jurisdiction` defaults to "AU"

**Response** (201 Created):

```json
{
  "id": "uuid",
  "title": "Smith v Jones",
  "description": "Commercial dispute...",
  "matter_number": "M-2025-001",
  "status": "active",
  "jurisdiction": "AU",
  "created_by": "uuid",
  "created_at": "2025-12-23T10:00:00Z",
  "updated_at": "2025-12-23T10:00:00Z"
}
```

**TypeScript Usage**:

```typescript
const { data, error } = await supabase
  .from("matters")
  .insert({
    title: "Smith v Jones",
    description: "Commercial dispute...",
  })
  .select()
  .single();
```

---

### Update Matter

**Request**:

```
PATCH /rest/v1/matters?id=eq.{id}
Authorization: Bearer {jwt}
Content-Type: application/json
Prefer: return=representation

{
  "title": "Updated Title",
  "status": "closed"
}
```

**Allowed Fields**:

- `title`
- `description`
- `status` (active, closed, archived)

**Response** (200 OK):

```json
{
  "id": "uuid",
  "title": "Updated Title",
  "status": "closed",
  ...
}
```

**TypeScript Usage**:

```typescript
const { data, error } = await supabase
  .from("matters")
  .update({ title: "Updated Title", status: "closed" })
  .eq("id", matterId)
  .select()
  .single();
```

---

### Delete Matter

**Request**:

```
DELETE /rest/v1/matters?id=eq.{id}
Authorization: Bearer {jwt}
```

**Notes**:

- Cascades to documents and participants
- Only matter owner can delete

**Response** (204 No Content)

**TypeScript Usage**:

```typescript
const { error } = await supabase.from("matters").delete().eq("id", matterId);
```

---

## Error Responses

| Status | Code       | Description                                  |
| ------ | ---------- | -------------------------------------------- |
| 400    | `PGRST102` | Invalid request body                         |
| 401    | `PGRST301` | Missing or invalid JWT                       |
| 403    | `PGRST301` | RLS policy violation (not owner/participant) |
| 404    | `PGRST116` | Matter not found                             |
| 409    | `23505`    | Duplicate matter_number (shouldn't happen)   |

---

## Matter Participants Sub-Resource

### List Participants

```typescript
const { data } = await supabase
  .from("matter_participants")
  .select("*, profiles(*)")
  .eq("matter_id", matterId);
```

### Add Participant

```typescript
const { data } = await supabase
  .from("matter_participants")
  .insert({
    matter_id: matterId,
    user_id: userId,
    role: "counsel", // or 'client', 'observer'
  })
  .select("*, profiles(*)")
  .single();
```

### Update Participant Role

```typescript
const { data } = await supabase
  .from("matter_participants")
  .update({ role: "observer" })
  .eq("id", participantId)
  .select()
  .single();
```

### Remove Participant

```typescript
const { error } = await supabase
  .from("matter_participants")
  .delete()
  .eq("id", participantId);
```

---

## TypeScript Types

```typescript
interface Matter {
  id: string;
  title: string;
  description: string | null;
  matter_number: string;
  status: "active" | "closed" | "archived";
  jurisdiction: string;
  created_by: string;
  created_at: string;
  updated_at: string;
}

interface MatterWithDocumentCount extends Matter {
  documents: [{ count: number }];
}

interface MatterParticipant {
  id: string;
  matter_id: string;
  user_id: string;
  role: "counsel" | "client" | "observer";
  added_at: string;
  profiles?: Profile;
}

interface CreateMatterInput {
  title: string;
  description?: string;
}

interface UpdateMatterInput {
  title?: string;
  description?: string;
  status?: "active" | "closed" | "archived";
}
```
